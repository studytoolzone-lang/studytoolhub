<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
const fileInput = document.getElementById("fileInput");
const compressBtn = document.getElementById("compressBtn");
const downloadBtn = document.getElementById("downloadBtn");

let originalPDF;

fileInput.addEventListener("change", function () {
    originalPDF = this.files[0];
    compressBtn.disabled = false;
});

/* ---------------- REAL PDF COMPRESSION ---------------- */
async function compressPDF(file, quality = 0.5) {
    const arrayBuffer = await file.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);

    const pages = pdfDoc.getPages();

    for (let page of pages) {
        const { width, height } = page.getSize();

        // Convert Page to JPEG Image
        const jpgImage = await page.renderToImage({ 
            width: width * quality, 
            height: height * quality, 
            format: "jpeg", 
            quality: quality 
        });

        const embed = await pdfDoc.embedJpg(jpgImage.data);

        page.drawImage(embed, {
            x: 0,
            y: 0,
            width: width,
            height: height
        });
    }

    const compressedPdfBytes = await pdfDoc.save({
        useObjectStreams: true,
        compress: true,
    });

    return compressedPdfBytes;
}

compressBtn.addEventListener("click", async () => {
    compressBtn.innerText = "Compressing...";
    compressBtn.disabled = true;

    const compressedPdfBytes = await compressPDF(originalPDF, 0.6);

    const blob = new Blob([compressedPdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    downloadBtn.dataset.url = url;

    document.getElementById("resultContainer").classList.add("active");
    compressBtn.innerText = "Compress PDF";
    compressBtn.disabled = false;
});

/* ---------------- DOWNLOAD BUTTON ---------------- */
downloadBtn.addEventListener("click", () => {
    const url = downloadBtn.dataset.url;

    const a = document.createElement("a");
    a.href = url;
    a.download = "compressed.pdf";
    a.click();
});
</script>
